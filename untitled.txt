set hive.execution.engine=tez;
set hive.tez.container.size = 10572;

drop table if exists dumbo.wavve_seg_temp;
create table dumbo.wavve_seg_temp as
SELECT A.svc_mgmt_num
       , A.seg_id
    FROM (SELECT TB.svc_mgmt_num
               , TB.seg_id
               , (CASE WHEN (count(dimension) = SUM(condition_value)) THEN 1 ELSE 0 END) AS CHECK
            FROM (SELECT T.svc_mgmt_num
                       , T2.seg_id
                       , T2.dimension
                       , T2.condition_id
                       , (CASE WHEN CAST(T.value AS INT) BETWEEN CAST(T2.condition_min AS INT) AND CAST(T2.condition_max AS INT) THEN 1 ELSE 0 END) as condition_value
                    FROM (SELECT *
                            FROM comm.user_profile_monthly
                           WHERE ym = '202008') AS T
                   INNER JOIN (SELECT *
                                 FROM dumbo.dpo_seg_info_meta
                                WHERE prod_id = 'RP0401'
                                  AND dt ='20200813') AS T2
                      ON T.dimension = T2.dimension) as TB
           GROUP BY TB.svc_mgmt_num
                   , TB.seg_id) as A
   WHERE A.CHECK = 1;

drop table if exists dumbo.wavve_user;
create table dumbo.wavve_user as
SELECT  t.svc_mgmt_num
,       'VAS0000001' prod_id
,       'wavve' prod_nm
,       'Y' as impression_yn
,       0.001 as score
,       0.001 as percent_rk  -- 유료 부가서비스보다 순위 내리기 위해
,       nvl(t2.seg_id, '#') as seg_id
FROM (SELECT svc_mgmt_num
       FROM comm.addition_rule
      WHERE reco_type = 'wavve_rule'
        AND ym = '202008') as t
LEFT JOIN (select * from dumbo.wavve_seg_temp) as t2
  ON t.svc_mgmt_num = t2.svc_mgmt_num;
  

INSERT OVERWRITE TABLE comm_dev.seg_reco_predict_post_filter PARTITION (reco_type = 'vas_wavve_rule', model = 'wavve_rule', dt = '20200831')
SELECT t.*
  FROM (select * from dumbo.wavve_user) as t
  LEFT JOIN (SELECT svc_mgmt_num
               FROM comm_dev.user_profile_monthly
              WHERE ym = '202008'
                AND dimension = 'additional_svc_pooq_scrb_type') as t2
   ON t.svc_mgmt_num = t2.svc_mgmt_num
WHERE t2.svc_mgmt_num is null;
  
                                    